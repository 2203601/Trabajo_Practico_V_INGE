# ===========================================
# COFFEEHUB CI/CD - QA y PRODUCCI√ìN (Azure + MongoDB)
# Con Tests Autom√°ticos Integrados
# ===========================================

trigger:
  branches:
    include:
      - main

pool:
  name: SelfHosted

variables:
  - group: CoffeeHub-Secrets  
  - name: RESOURCE_GROUP_NAME
    value: 'TPS-INGE-2025'
  - name: azureServiceConnection
    value: 'azure-tp05-connection'
  - name: backendAppNameQA
    value: 'Coffeehub-Back-QA'
  - name: frontendAppNameQA
    value: 'Coffeehub-Front-QA'
  - name: backendAppNameProd
    value: 'Coffeehub-Back-Prod'
  - name: frontendAppNameProd
    value: 'Coffeehub-Front-Prod'

# ==================== STAGE 1: BUILD Y TESTS ====================
stages:
- stage: Build_And_Test
  displayName: "CI: Instalar, Probar y Empaquetar"
  jobs:
  - job: BuildAndTestBackend
    displayName: "üî® Build + Tests Backend"
    steps:
      # ---- Instalar dependencias ----
      - script: |
          echo "üì¶ Instalando dependencias del backend..."
          npm install
        displayName: 'üì¶ Instalar Dependencias Backend'
        workingDirectory: 'coffehub/backend'

      # ---- Ejecutar Tests Unitarios ----
      - script: |
          echo "üß™ Ejecutando tests unitarios con mocks..."
          npm run test:ci
        displayName: 'üß™ Tests Unitarios'
        workingDirectory: 'coffehub/backend'
        continueOnError: false

      # ---- Publicar Resultados de Tests ----
      - task: PublishTestResults@2
        displayName: 'üìã Publicar Resultados de Tests'
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/junit.xml'
          searchFolder: 'coffehub/backend'
          mergeTestResults: true
          failTaskOnFailedTests: true
          testRunTitle: 'Backend Tests'
        condition: succeededOrFailed()

      # ---- Publicar Coverage ----
      - task: PublishCodeCoverageResults@1
        displayName: 'üìä Publicar Code Coverage'
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coffehub/backend/coverage/cobertura-coverage.xml'
          reportDirectory: 'coffehub/backend/coverage'
        condition: succeededOrFailed()

      # ---- Publicar Artefacto Backend ----
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: 'coffehub/backend'
          artifact: 'backend-code'
        displayName: "üì¶ Publicar C√≥digo Backend"
        condition: succeeded()

  - job: BuildFrontend
    displayName: "üî® Build Frontend"
    steps:
      - script: |
          echo "üì¶ Instalando dependencias del frontend..."
          npm install
        displayName: 'üì¶ Instalar Dependencias Frontend'
        workingDirectory: 'coffehub/frontend'

      # ---- Tests del Frontend ----
      - script: |
          echo "üß™ Ejecutando tests del frontend..."
          npm run test:ci
        displayName: 'üß™ Tests Frontend'
        workingDirectory: 'coffehub/frontend'
        continueOnError: false

      # ---- Publicar Resultados de Tests Frontend ----
      - task: PublishTestResults@2
        displayName: 'üìã Publicar Resultados Tests Frontend'
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/junit.xml'
          searchFolder: 'coffehub/frontend'
          mergeTestResults: true
          failTaskOnFailedTests: true
          testRunTitle: 'Frontend Tests'
        condition: succeededOrFailed()

      # ---- Publicar Coverage Frontend ----
      - task: PublishCodeCoverageResults@1
        displayName: 'üìä Publicar Code Coverage Frontend'
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coffehub/frontend/coverage/cobertura-coverage.xml'
          reportDirectory: 'coffehub/frontend/coverage'
        condition: succeededOrFailed()

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: 'coffehub/frontend'
          artifact: 'frontend-code'
        displayName: "üì¶ Publicar C√≥digo Frontend"
        condition: succeeded()


# ==================== STAGE 2: DEPLOY QA ====================
- stage: Deploy_QA
  displayName: "CD: Desplegar QA + Smoke Tests"
  dependsOn: Build_And_Test
  condition: succeeded()
  jobs:
  - deployment: DeployQA
    environment: 'QA'
    strategy:
      runOnce:
        deploy:
          steps:
            # ---- Backend QA ----
            - task: DownloadPipelineArtifact@2
              inputs:
                artifact: 'backend-code'
                path: '$(Pipeline.Workspace)/backend-source' 

            - task: AzureWebApp@1
              displayName: "üöÄ Deploy Backend QA"
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                appName: '$(backendAppNameQA)'
                package: '$(Pipeline.Workspace)/backend-source'
                runtimeStack: 'NODE|18-lts'
                startUpCommand: 'npm install && npm start'

            # ---- Configurar MongoDB QA ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar MONGODB_URI_QA en Backend'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  BACKEND_APP='$(backendAppNameQA)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando MongoDB QA en $BACKEND_APP"
                  az webapp config appsettings set \
                    --name "$BACKEND_APP" \
                    --resource-group "$RG" \
                    --settings \
                      MONGODB_URI="$(MONGODB_URI_QA)" \
                      NODE_ENV="qa"

            # ---- Frontend QA ----
            - task: DownloadPipelineArtifact@2
              inputs:
                artifact: 'frontend-code'
                path: '$(Pipeline.Workspace)/frontend-source'

            - task: AzureWebApp@1
              displayName: "üöÄ Deploy Frontend QA"
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                appName: '$(frontendAppNameQA)'
                package: '$(Pipeline.Workspace)/frontend-source'
                runtimeStack: 'NODE|18-lts'
                startUpCommand: 'npm install && npm start'

            # ---- Configurar Frontend QA ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar BACKEND_URL en Frontend QA'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  BACKEND_URL_VAL="https://coffeehub-back-qa-argeftdrb3dkb9du.brazilsouth-01.azurewebsites.net"
                  FRONTEND_APP='$(frontendAppNameQA)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando BACKEND_URL en $FRONTEND_APP"
                  az webapp config appsettings set \
                    --name "$FRONTEND_APP" \
                    --resource-group "$RG" \
                    --settings BACKEND_URL="$BACKEND_URL_VAL"

            # ---- Configurar CORS QA ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar CORS en Backend QA'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  FRONTEND_URL_VAL="https://coffeehub-front-qa-argqggbvc3g0gkdc.brazilsouth-01.azurewebsites.net"
                  BACKEND_APP='$(backendAppNameQA)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando CORS para $FRONTEND_URL_VAL"
                  az webapp cors add \
                    --name "$BACKEND_APP" \
                    --resource-group "$RG" \
                    --allowed-origins "$FRONTEND_URL_VAL"

            # ---- Smoke Tests QA ----
            - script: |
                echo "üîç Ejecutando Smoke Tests en QA..."
                sleep 30
                BACKEND_URL="https://coffeehub-back-qa-argeftdrb3dkb9du.brazilsouth-01.azurewebsites.net"
                
                echo "Testing /api/health..."
                response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/health")
                if [ $response -eq 200 ]; then
                  echo "‚úÖ Health check passed!"
                else
                  echo "‚ùå Health check failed! Status: $response"
                  exit 1
                fi
                
                echo "Testing /api/products..."
                response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/products")
                if [ $response -eq 200 ]; then
                  echo "‚úÖ Products endpoint passed!"
                else
                  echo "‚ùå Products endpoint failed! Status: $response"
                  exit 1
                fi
              displayName: 'üîç Smoke Tests QA'
              continueOnError: false


# ==================== STAGE 3: DEPLOY PROD ====================
- stage: Deploy_PROD
  displayName: "CD: Desplegar Producci√≥n + Verificaci√≥n"
  dependsOn: Deploy_QA
  condition: succeeded()
  jobs:
  - deployment: DeployPROD
    environment: 'PROD'
    strategy:
      runOnce:
        deploy:
          steps:
            # ---- Backend PROD ----
            - task: DownloadPipelineArtifact@2
              inputs:
                artifact: 'backend-code'
                path: '$(Pipeline.Workspace)/backend-source'

            - task: AzureWebApp@1
              displayName: "üöÄ Deploy Backend PROD"
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                appName: '$(backendAppNameProd)'
                package: '$(Pipeline.Workspace)/backend-source'
                runtimeStack: 'NODE|18-lts'
                startUpCommand: 'npm install && npm start'

            # ---- Configurar MongoDB PROD ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar MONGODB_URI_PROD en Backend'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  BACKEND_APP='$(backendAppNameProd)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando MongoDB PROD en $BACKEND_APP"
                  az webapp config appsettings set \
                    --name "$BACKEND_APP" \
                    --resource-group "$RG" \
                    --settings \
                      MONGODB_URI="$(MONGODB_URI_PROD)" \
                      NODE_ENV="production"

            # ---- Configurar CORS PROD PRIMERO ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar CORS en Backend PROD (ANTES de smoke tests)'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  FRONTEND_URL_VAL="https://coffeehub-front-prod-hgh2ehb7bzchh4ft.brazilsouth-01.azurewebsites.net"
                  BACKEND_APP='$(backendAppNameProd)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando CORS en $BACKEND_APP"
                  az webapp cors add \
                    --name "$BACKEND_APP" \
                    --resource-group "$RG" \
                    --allowed-origins "$FRONTEND_URL_VAL"

            # ---- Frontend PROD ----
            - task: DownloadPipelineArtifact@2
              inputs:
                artifact: 'frontend-code'
                path: '$(Pipeline.Workspace)/frontend-source'

            - task: AzureWebApp@1
              displayName: "üöÄ Deploy Frontend PROD"
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                appName: '$(frontendAppNameProd)'
                package: '$(Pipeline.Workspace)/frontend-source'
                runtimeStack: 'NODE|18-lts'
                startUpCommand: 'npm install && npm start'

            # ---- Configurar Frontend PROD ----
            - task: AzureCLI@2
              displayName: '‚öôÔ∏è Configurar BACKEND_URL en Frontend PROD'
              inputs:
                azureSubscription: '$(azureServiceConnection)'
                scriptType: 'bash'
                scriptLocation: 'inlineScript'
                inlineScript: |
                  BACKEND_URL_VAL="https://coffeehub-back-prod-bzgaa5ekbed7fret.brazilsouth-01.azurewebsites.net"
                  FRONTEND_APP='$(frontendAppNameProd)'
                  RG='$(RESOURCE_GROUP_NAME)'
                  echo "‚û°Ô∏è Configurando BACKEND_URL en $FRONTEND_APP"
                  az webapp config appsettings set \
                    --name "$FRONTEND_APP" \
                    --resource-group "$RG" \
                    --settings BACKEND_URL="$BACKEND_URL_VAL"

            # ---- Smoke Tests PROD CON M√ÅS ESPERA Y MEJOR DEBUGGING ----
            - script: |
                echo "üîç Ejecutando Smoke Tests en PROD..."
                sleep 60
                BACKEND_URL="https://coffeehub-back-prod-bzgaa5ekbed7fret.brazilsouth-01.azurewebsites.net"
                MAX_RETRIES=5
                RETRY_COUNT=0
                
                echo "Testing /api/health..."
                while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                  echo "Intento $((RETRY_COUNT + 1))/$MAX_RETRIES..."
                  response=$(curl -s -w "\n%{http_code}" "$BACKEND_URL/api/health")
                  http_code=$(echo "$response" | tail -n1)
                  body=$(echo "$response" | head -n-1)
                  
                  echo "Response Code: $http_code"
                  echo "Response Body: $body"
                  
                  if [ "$http_code" -eq 200 ]; then
                    echo "‚úÖ Health check passed!"
                    break
                  else
                    echo "‚ö†Ô∏è Status: $http_code"
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                      echo "Esperando 10 segundos antes de reintentar..."
                      sleep 10
                    fi
                  fi
                done
                
                if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                  echo "‚ùå Health check fall√≥ despu√©s de $MAX_RETRIES intentos"
                  exit 1
                fi
                
                echo "Testing /api/products..."
                response=$(curl -s -w "\n%{http_code}" "$BACKEND_URL/api/products")
                http_code=$(echo "$response" | tail -n1)
                body=$(echo "$response" | head -n-1)
                
                echo "Response Code: $http_code"
                echo "Response Body: $body"
                
                if [ "$http_code" -eq 200 ]; then
                  echo "‚úÖ Products endpoint passed!"
                else
                  echo "‚ùå Products endpoint failed! Status: $http_code"
                  exit 1
                fi
                
                echo "üéâ Deployment a PROD completado exitosamente!"
              displayName: 'üîç Smoke Tests PROD (Con Retry)'
              continueOnError: false