trigger:
  - main

pool:
  name: SelfHosted

variables:
  azureSubscription: 'azure-tp05-connection'
  backendQA: 'CoffeeHub-Back-QA'
  frontendQA: 'CoffeeHub-Front-QA'
  backendPROD: 'CoffeeHub-Back-Prod'
  frontendPROD: 'CoffeeHub-Front-Prod'

stages:
# ---------------- CI ----------------
- stage: CI
  displayName: "Continuous Integration"
  jobs:
    - job: Backend
      displayName: "Backend CI"
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'

        - script: |
            cd coffehub/backend
            npm install
          displayName: "Install Backend"

        - script: |
            cd coffehub/backend
            npm test || echo "Tests skipped (no DB available)"
          displayName: "Run Backend Tests (Optional)"
          continueOnError: true

        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: 'coffehub/backend/dist'
            artifact: 'backend'
          displayName: "Publish Backend Artifact"

    - job: Frontend
      displayName: "Frontend CI"
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'

        - script: |
            cd coffehub/frontend
            npm install || true
            npm run build || echo "No build script definido"
          displayName: "Build Frontend"

        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: 'coffehub/frontend/build'
            artifact: 'frontend'
          displayName: "Publish Frontend Artifact"

# ---------------- QA ----------------
- stage: DeployQA
  displayName: "Deploy to QA"
  dependsOn: CI
  condition: succeeded()
  jobs:
    - deployment: DeployQAJob
      displayName: "Deploy to QA Environment"
      environment: "QA"
      strategy:
        runOnce:
          deploy:
            steps:
              # Usamos artifacts directamente desde CI
              - download: current
                artifact: backend
                displayName: "Get Backend Artifact"

              - download: current
                artifact: frontend
                displayName: "Get Frontend Artifact"

              - task: AzureWebApp@1
                displayName: "Deploy Backend to QA"
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webApp'
                  appName: '$(backendQA)'
                  package: '$(Pipeline.Workspace)/backend'

              - task: AzureWebApp@1
                displayName: "Deploy Frontend to QA"
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webApp'
                  appName: '$(frontendQA)'
                  package: '$(Pipeline.Workspace)/frontend'

# ---------------- PROD ----------------
- stage: DeployPROD
  displayName: "Deploy to PROD"
  dependsOn: DeployQA
  condition: succeeded()
  jobs:
    - deployment: DeployPRODJob
      displayName: "Deploy to PROD Environment"
      environment: "PROD"
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: backend
                displayName: "Get Backend Artifact"

              - download: current
                artifact: frontend
                displayName: "Get Frontend Artifact"

              - task: AzureWebApp@1
                displayName: "Deploy Backend to PROD"
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webApp'
                  appName: '$(backendPROD)'
                  package: '$(Pipeline.Workspace)/backend'

              - task: AzureWebApp@1
                displayName: "Deploy Frontend to PROD"
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webApp'
                  appName: '$(frontendPROD)'
                  package: '$(Pipeline.Workspace)/frontend'
